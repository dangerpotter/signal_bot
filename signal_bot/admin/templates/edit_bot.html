{% extends "base.html" %}

{% block title %}Edit {{ bot.name }} - Signal Bot Admin{% endblock %}

{% block content %}
<div class="row mb-4">
    <div class="col">
        <h1><i class="bi bi-pencil"></i> Edit Bot: {{ bot.name }}</h1>
    </div>
</div>

<form action="{{ url_for('edit_bot', bot_id=bot.id) }}" method="post">
    <div class="row">
        <div class="col-md-6">
            <div class="card mb-4">
                <div class="card-header">Basic Settings</div>
                <div class="card-body">
                    <div class="mb-3">
                        <label class="form-label">Bot Name</label>
                        <input type="text" name="name" class="form-control" value="{{ bot.name }}" required>
                    </div>
                    <div class="mb-3">
                        <label class="form-label">AI Model</label>
                        <select name="model" class="form-select" required>
                            {% for display_name, model_id in all_models.items() %}
                            <option value="{{ model_id }}" {% if model_id == bot.model %}selected{% endif %}>{{ display_name }}</option>
                            {% endfor %}
                        </select>
                    </div>
                    <div class="mb-3">
                        <label class="form-label">Phone Number</label>
                        <input type="text" name="phone_number" class="form-control" value="{{ bot.phone_number or '' }}" placeholder="+1234567890">
                    </div>
                    <div class="mb-3">
                        <label class="form-label">Signal API Port</label>
                        <select name="signal_api_port" class="form-select">
                            <option value="8080" {% if bot.signal_api_port == 8080 %}selected{% endif %}>8080 (Bot 1)</option>
                            <option value="8081" {% if bot.signal_api_port == 8081 %}selected{% endif %}>8081 (Bot 2)</option>
                            <option value="8082" {% if bot.signal_api_port == 8082 %}selected{% endif %}>8082 (Bot 3)</option>
                        </select>
                    </div>
                </div>
            </div>

            <div class="card mb-4">
                <div class="card-header">
                    <i class="bi bi-signal"></i> Signal Features
                </div>
                <div class="card-body">
                    <div class="mb-3">
                        <div class="form-check form-switch">
                            <input type="checkbox" name="typing_enabled" class="form-check-input" id="typingEnabled" {% if bot.typing_enabled is not defined or bot.typing_enabled %}checked{% endif %}>
                            <label class="form-check-label" for="typingEnabled">Send typing indicators</label>
                        </div>
                        <small class="text-muted">Show "typing..." while bot composes a response</small>
                    </div>
                    <div class="mb-3">
                        <div class="form-check form-switch">
                            <input type="checkbox" name="read_receipts_enabled" class="form-check-input" id="readReceipts" {% if bot.read_receipts_enabled %}checked{% endif %}>
                            <label class="form-check-label" for="readReceipts">Send read receipts</label>
                        </div>
                        <small class="text-muted">Mark messages as read when bot sees them</small>
                    </div>
                    <hr>
                    <p class="text-muted mb-0">
                        <small>
                            <i class="bi bi-info-circle"></i>
                            <strong>Also enabled:</strong> Quote/reply to messages, text styling (**bold**, *italic*, `code`), link previews
                        </small>
                    </p>
                </div>
            </div>

            <div class="card mb-4">
                <div class="card-header">
                    <i class="bi bi-emoji-smile"></i> Reaction Settings
                </div>
                <div class="card-body">
                    <div class="mb-3">
                        <div class="form-check form-switch">
                            <input type="checkbox" name="reaction_tool_enabled" class="form-check-input" id="reactionToolEnabled" {% if bot.reaction_tool_enabled %}checked{% endif %}>
                            <label class="form-check-label" for="reactionToolEnabled">Enable reaction tool</label>
                        </div>
                        <small class="text-muted">Bot can react to messages with emoji during responses. The AI reads the conversation and decides which messages deserve reactions. (requires tool-capable model)</small>
                    </div>
                    <div class="mb-3">
                        <label class="form-label">Max Reactions Per Response</label>
                        <input type="number" name="max_reactions_per_response" class="form-control" min="1" max="10" value="{{ bot.max_reactions_per_response or 3 }}">
                        <small class="text-muted">Maximum emoji reactions the bot can add per response (1-10)</small>
                    </div>
                </div>
            </div>

            <div class="card mb-4">
                <div class="card-header">
                    <i class="bi bi-newspaper"></i> Idle News Settings
                </div>
                <div class="card-body">
                    <div class="mb-3">
                        <div class="form-check form-switch">
                            <input type="checkbox" name="idle_news_enabled" class="form-check-input" id="idleNewsEnabled" {% if bot.idle_news_enabled %}checked{% endif %}>
                            <label class="form-check-label" for="idleNewsEnabled">Enable idle news posting</label>
                        </div>
                        <small class="text-muted">Post interesting news when group goes quiet (requires web search enabled)</small>
                    </div>
                    <div class="mb-3">
                        <label class="form-label">Idle Threshold (minutes)</label>
                        <input type="number" name="idle_threshold_minutes" class="form-control" min="5" max="120" value="{{ bot.idle_threshold_minutes or 15 }}">
                        <small class="text-muted">How long the group must be quiet before idle mode activates (5-120)</small>
                    </div>
                    <div class="mb-3">
                        <label class="form-label">Check Interval (minutes)</label>
                        <input type="number" name="idle_check_interval_minutes" class="form-control" min="1" max="30" value="{{ bot.idle_check_interval_minutes or 5 }}">
                        <small class="text-muted">How often to check idle groups for news posting (1-30)</small>
                    </div>
                    <div class="mb-3">
                        <label class="form-label">Trigger Chance (%)</label>
                        <input type="range" name="idle_trigger_chance_percent" class="form-range" min="5" max="50" value="{{ bot.idle_trigger_chance_percent or 10 }}" id="idleChance" oninput="document.getElementById('idleChanceValue').textContent = this.value + '%'">
                        <span id="idleChanceValue">{{ bot.idle_trigger_chance_percent or 10 }}%</span>
                        <br><small class="text-muted">Probability of posting news each check interval (5-50%)</small>
                    </div>
                </div>
            </div>

            <div class="card mb-4 border-warning">
                <div class="card-header bg-warning text-dark">
                    <i class="bi bi-tools"></i> Maintenance
                </div>
                <div class="card-body">
                    <h6>Clear Message Logs</h6>
                    <p class="text-muted small">Delete all message history for this bot's assigned groups. Use this to fix context pollution issues.</p>
                    <button type="button" class="btn btn-warning btn-sm" onclick="clearLogs()">
                        <i class="bi bi-trash"></i> Clear Message Logs
                    </button>
                </div>
            </div>
        </div>

        <div class="col-md-6">
            <div class="card mb-4">
                <div class="card-header">Response Settings</div>
                <div class="card-body">
                    <div class="mb-3">
                        <div class="form-check form-switch">
                            <input type="checkbox" name="respond_on_mention" class="form-check-input" id="respondMention" {% if bot.respond_on_mention %}checked{% endif %}>
                            <label class="form-check-label" for="respondMention">Respond when mentioned</label>
                        </div>
                    </div>
                    <div class="mb-3">
                        <label class="form-label">Random Response Chance (%)</label>
                        <input type="range" name="random_chance_percent" class="form-range" min="0" max="50" value="{{ bot.random_chance_percent }}" id="randomChance" oninput="document.getElementById('randomValue').textContent = this.value + '%'">
                        <span id="randomValue">{{ bot.random_chance_percent }}%</span>
                    </div>
                    <div class="mb-3">
                        <label class="form-label">Context Window (messages)</label>
                        <input type="range" name="context_window" class="form-range" min="5" max="100" value="{{ bot.context_window or 25 }}" id="contextWindow" oninput="document.getElementById('contextValue').textContent = this.value">
                        <span id="contextValue">{{ bot.context_window or 25 }}</span>
                        <br><small class="text-muted">Number of recent messages to include in context (default: 25)</small>
                    </div>
                    <div class="mb-3">
                        <div class="form-check form-switch">
                            <input type="checkbox" name="image_generation_enabled" class="form-check-input" id="imageGen" {% if bot.image_generation_enabled %}checked{% endif %}>
                            <label class="form-check-label" for="imageGen">Enable image generation (!image)</label>
                        </div>
                    </div>
                    <div class="mb-3">
                        <div class="form-check form-switch">
                            <input type="checkbox" name="web_search_enabled" class="form-check-input" id="webSearch" {% if bot.web_search_enabled %}checked{% endif %}>
                            <label class="form-check-label" for="webSearch">Enable web search (real-time data)</label>
                        </div>
                        <small class="text-muted">Uses OpenRouter's web search plugin for current info</small>
                    </div>
                    <div class="mb-3">
                        <div class="form-check form-switch">
                            <input type="checkbox" name="weather_enabled" class="form-check-input" id="weatherEnabled" {% if bot.weather_enabled %}checked{% endif %}>
                            <label class="form-check-label" for="weatherEnabled">Enable weather tool</label>
                        </div>
                        <small class="text-muted">Accurate weather data via WeatherAPI.com (requires tool-capable model)</small>
                    </div>
                    <div class="mb-3">
                        <div class="form-check form-switch">
                            <input type="checkbox" name="finance_enabled" class="form-check-input" id="financeEnabled" {% if bot.finance_enabled %}checked{% endif %}>
                            <label class="form-check-label" for="financeEnabled">Enable finance tools</label>
                        </div>
                        <small class="text-muted">Yahoo Finance data for stocks, ETFs, and crypto. Includes: stock quotes, company news, symbol search, top performers by sector, price history, options chains, and earnings data. Bot responds to any ticker/company mentioned.</small>
                    </div>
                    <div class="mb-3">
                        <div class="form-check form-switch">
                            <input type="checkbox" name="time_enabled" class="form-check-input" id="timeEnabled" {% if bot.time_enabled %}checked{% endif %}>
                            <label class="form-check-label" for="timeEnabled">Enable time/date tool</label>
                        </div>
                        <small class="text-muted">Accurate time and date across timezones. Supports IANA timezone names like America/New_York, America/Chicago, America/Denver, America/Los_Angeles (requires tool-capable model)</small>
                    </div>
                    <div class="mb-3">
                        <div class="form-check form-switch">
                            <input type="checkbox" name="wikipedia_enabled" class="form-check-input" id="wikipediaEnabled" {% if bot.wikipedia_enabled %}checked{% endif %}>
                            <label class="form-check-label" for="wikipediaEnabled">Enable Wikipedia tool</label>
                        </div>
                        <small class="text-muted">Search and retrieve Wikipedia articles. Includes article search, full summaries, and random articles (requires tool-capable model)</small>
                    </div>
                </div>
            </div>

            <div class="card mb-4">
                <div class="card-header">
                    <i class="bi bi-person-badge"></i> Member Memory Settings
                </div>
                <div class="card-body">
                    <div class="mb-3">
                        <div class="form-check form-switch">
                            <input type="checkbox" name="member_memory_tools_enabled" class="form-check-input" id="memberMemoryToolsEnabled" {% if bot.member_memory_tools_enabled %}checked{% endif %}>
                            <label class="form-check-label" for="memberMemoryToolsEnabled">Enable member memory tools</label>
                        </div>
                        <small class="text-muted">Bot can save and recall information about group members (save_member_memory, get_member_memories, list_group_members). When the bot learns personal details about someone, it can explicitly save them for future reference. (requires tool-capable model)</small>
                    </div>
                    <hr>
                    <div class="mb-3">
                        <label class="form-label">Relevance Detection Model (for auto-scan)</label>
                        <select name="member_memory_model" class="form-select">
                            <option value="">-- None (use keywords only) --</option>
                            {% for display_name, model_id in all_models.items() %}
                            <option value="{{ model_id }}" {% if model_id == bot.member_memory_model %}selected{% endif %}>{{ display_name }}</option>
                            {% endfor %}
                        </select>
                        <small class="text-muted">Small/fast model for background scanning when location info is relevant. Use Haiku for speed, Sonnet for accuracy. Leave empty to use keyword matching only.</small>
                    </div>
                    <p class="text-muted small mb-0">
                        <i class="bi bi-info-circle"></i>
                        Member memories (home location, interests, etc.) are managed in <a href="{{ url_for('member_memories_list') }}">Member Memories</a>.
                        The tools above let the bot save explicitly, while auto-scan runs in background.
                    </p>
                </div>
            </div>

            <div class="card mb-4">
                <div class="card-header">
                    <i class="bi bi-file-earmark-spreadsheet"></i> Google Sheets Integration
                </div>
                <div class="card-body">
                    <div class="mb-3">
                        <div class="form-check form-switch">
                            <input type="checkbox" name="google_sheets_enabled" class="form-check-input" id="sheetsEnabled" {% if bot.google_sheets_enabled %}checked{% endif %}>
                            <label class="form-check-label" for="sheetsEnabled">Enable Google Sheets tools</label>
                        </div>
                        <small class="text-muted">Bot can create and manage spreadsheets for expense tracking, lists, and collaborative data (requires tool-capable model)</small>
                    </div>

                    <hr>

                    <h6>OAuth Credentials</h6>
                    <p class="text-muted small mb-2">
                        <a href="https://console.cloud.google.com/apis/credentials" target="_blank">Create OAuth credentials</a> in Google Cloud Console.
                        Enable <strong>Sheets API</strong> and <strong>Drive API</strong>.
                        Add this redirect URI: <code>{{ url_for('google_oauth_callback', _external=True) }}</code>
                    </p>

                    <div class="mb-3">
                        <label class="form-label">Client ID</label>
                        <input type="text" name="google_client_id" class="form-control" value="{{ bot.google_client_id or '' }}" placeholder="123456789.apps.googleusercontent.com">
                    </div>
                    <div class="mb-3">
                        <label class="form-label">Client Secret</label>
                        <input type="password" name="google_client_secret" class="form-control" value="" placeholder="{% if bot.google_client_secret %}(configured - leave blank to keep){% else %}Enter client secret{% endif %}">
                        <small class="text-muted">Leave blank to keep existing secret</small>
                    </div>

                    <hr>

                    <h6>Connection Status</h6>
                    {% if bot.google_connected %}
                        <div class="alert alert-success mb-3">
                            <i class="bi bi-check-circle"></i> <strong>Connected to Google</strong>
                            {% if bot.google_token_expiry %}
                                <br><small>Token refreshes automatically</small>
                            {% endif %}
                        </div>
                        <button type="button" class="btn btn-outline-danger btn-sm" onclick="disconnectGoogle()">
                            <i class="bi bi-x-circle"></i> Disconnect
                        </button>
                    {% else %}
                        <div class="alert alert-warning mb-3">
                            <i class="bi bi-exclamation-triangle"></i> <strong>Not Connected</strong>
                            <br><small>Configure credentials and click Connect to authorize</small>
                        </div>
                        {% if bot.google_client_id and bot.google_client_secret %}
                            <a href="{{ url_for('google_oauth_start', bot_id=bot.id) }}" class="btn btn-primary btn-sm">
                                <i class="bi bi-google"></i> Connect to Google
                            </a>
                        {% else %}
                            <button class="btn btn-secondary btn-sm" disabled>
                                <i class="bi bi-google"></i> Configure credentials first
                            </button>
                        {% endif %}
                    {% endif %}
                </div>
            </div>

            <!-- Google Calendar Integration -->
            <div class="card mb-4">
                <div class="card-header">
                    <i class="bi bi-calendar-event"></i> Google Calendar Integration
                </div>
                <div class="card-body">
                    <div class="mb-3">
                        <div class="form-check form-switch">
                            <input type="checkbox" name="google_calendar_enabled" class="form-check-input" id="calendarEnabled" {% if bot.google_calendar_enabled %}checked{% endif %}>
                            <label class="form-check-label" for="calendarEnabled">Enable Google Calendar tools</label>
                        </div>
                        <small class="text-muted">Bot can create calendars, manage events, and share calendar links (requires tool-capable model)</small>
                    </div>

                    <div class="alert alert-info mb-0">
                        <i class="bi bi-info-circle"></i>
                        <small>
                            Calendar uses the same Google connection as Sheets. If you see permission errors,
                            <strong>disconnect and reconnect</strong> to grant Calendar access (new OAuth scope).
                        </small>
                    </div>

                    {% if not bot.google_connected %}
                    <div class="alert alert-warning mt-3 mb-0">
                        <i class="bi bi-exclamation-triangle"></i>
                        <small>Connect to Google (above) to enable Calendar features.</small>
                    </div>
                    {% endif %}
                </div>
            </div>

            <!-- Scheduled Triggers -->
            <div class="card mb-4">
                <div class="card-header">
                    <i class="bi bi-clock-history"></i> Scheduled Triggers
                </div>
                <div class="card-body">
                    <div class="mb-3">
                        <div class="form-check form-switch">
                            <input type="checkbox" name="triggers_enabled" class="form-check-input" id="triggersEnabled" {% if bot.triggers_enabled is not defined or bot.triggers_enabled %}checked{% endif %}>
                            <label class="form-check-label" for="triggersEnabled">Enable scheduled triggers</label>
                        </div>
                        <small class="text-muted">Allow scheduled reminders and AI tasks for this bot</small>
                    </div>

                    <div class="mb-3">
                        <label class="form-label">Max Triggers</label>
                        <input type="number" name="max_triggers" class="form-control" min="1" max="100" value="{{ bot.max_triggers if bot.max_triggers is defined else 10 }}">
                        <small class="text-muted">Maximum number of active triggers for this bot (1-100, default: 10)</small>
                    </div>

                    <hr>

                    <p class="text-muted small mb-0">
                        <i class="bi bi-info-circle"></i>
                        Manage triggers in the <a href="{{ url_for('triggers_list') }}?bot_id={{ bot.id }}">Triggers</a> tab.
                        Triggers can send reminders or execute AI tasks on a schedule.
                    </p>
                </div>
            </div>
        </div>

        <!-- D&D Game Master -->
        <div class="col-md-6">
            <div class="card mb-4">
                <div class="card-header">
                    <i class="bi bi-dice-6"></i> D&D Game Master
                </div>
                <div class="card-body">
                    <div class="mb-3">
                        <div class="form-check form-switch">
                            <input type="checkbox" name="dnd_enabled" class="form-check-input" id="dndEnabled" {% if bot.dnd_enabled %}checked{% endif %}>
                            <label class="form-check-label" for="dndEnabled">Enable D&D GM tools</label>
                        </div>
                        <small class="text-muted">Run D&D 5e campaigns with character sheets, combat tracking, and campaign management</small>
                    </div>

                    <div class="mb-3">
                        <label for="dndTemplateId" class="form-label">Campaign Template Spreadsheet ID</label>
                        <input type="text" class="form-control" id="dndTemplateId" name="dnd_template_spreadsheet_id"
                               value="{{ bot.dnd_template_spreadsheet_id or '' }}"
                               placeholder="e.g., 1BxiMVs0XRA5nFMdKvBdBZjgmUUqptlbs74OgvE2upms">
                        <small class="text-muted">Google Sheets ID of your campaign template. New campaigns will be created by copying this template.</small>
                    </div>

                    <hr>

                    <p class="text-muted small mb-0">
                        <i class="bi bi-info-circle"></i>
                        <strong>Requirements:</strong> Google Sheets must be connected (campaigns stored in spreadsheets).
                        <br>Use a GM-focused system prompt for best results. Dice rolling is always enabled.
                    </p>
                </div>
            </div>
        </div>
    </div>

    <div class="row">
        <div class="col-12">
            <div class="card mb-4">
                <div class="card-header">
                    System Prompt
                    <small class="text-muted ms-2">Define the bot's personality</small>
                </div>
                <div class="card-body">
                    <div class="mb-3">
                        <label class="form-label">Load from Template</label>
                        <select class="form-select" id="promptTemplate" onchange="loadPromptTemplate(this.value)">
                            <option value="">-- Select a template --</option>
                            {% for prompt in prompts %}
                            <option value="{{ prompt.prompt_text|e }}">{{ prompt.name }}</option>
                            {% endfor %}
                        </select>
                    </div>
                    <div class="mb-3">
                        <label class="form-label">Custom System Prompt</label>
                        <textarea name="system_prompt" class="form-control" rows="10" id="systemPrompt" placeholder="Enter a custom system prompt or select a template above...">{{ bot.system_prompt or '' }}</textarea>
                        <small class="text-muted">Leave empty to use the default prompt</small>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <div class="row">
        <div class="col">
            <a href="{{ url_for('bots_list') }}" class="btn btn-secondary">
                <i class="bi bi-arrow-left"></i> Back
            </a>
            <button type="submit" class="btn btn-primary">
                <i class="bi bi-check-lg"></i> Save Changes
            </button>
        </div>
    </div>
</form>

<script>
function loadPromptTemplate(value) {
    if (value) {
        document.getElementById('systemPrompt').value = value;
    }
}

function disconnectGoogle() {
    if (confirm('Disconnect from Google? You will need to re-authorize to use Sheets features.')) {
        // Create a temporary form and submit it
        var form = document.createElement('form');
        form.method = 'POST';
        form.action = '{{ url_for("google_oauth_disconnect", bot_id=bot.id) }}';
        document.body.appendChild(form);
        form.submit();
    }
}

function clearLogs() {
    if (confirm('Clear all message logs for this bot\'s groups? This will reset the conversation context and cannot be undone.')) {
        var form = document.createElement('form');
        form.method = 'POST';
        form.action = '{{ url_for("clear_bot_logs", bot_id=bot.id) }}';
        document.body.appendChild(form);
        form.submit();
    }
}
</script>
{% endblock %}
