{% extends "base.html" %}

{% block title %}Groups - Signal Bot Admin{% endblock %}

{% block content %}
<div class="row mb-4">
    <div class="col">
        <h1><i class="bi bi-people"></i> Group Management</h1>
    </div>
    <div class="col-auto">
        <button class="btn btn-primary" data-bs-toggle="modal" data-bs-target="#addGroupModal">
            <i class="bi bi-plus-lg"></i> Add Group
        </button>
    </div>
</div>

<div class="row">
    {% for group in groups %}
    <div class="col-md-6 mb-4">
        <div class="card h-100 {% if group.enabled %}border-success{% endif %}">
            <div class="card-header d-flex justify-content-between align-items-center">
                <span>
                    <i class="bi bi-people-fill"></i> {{ group.name }}
                </span>
                <div class="d-flex gap-1 align-items-center">
                    <a href="{{ url_for('edit_group', group_id=group.id) }}" class="btn btn-sm btn-outline-secondary" title="Edit">
                        <i class="bi bi-pencil"></i>
                    </a>
                    <button type="button" class="btn btn-sm btn-outline-danger" title="Delete" data-bs-toggle="modal" data-bs-target="#deleteGroupModal-{{ loop.index }}">
                        <i class="bi bi-trash"></i>
                    </button>
                    <form action="{{ url_for('toggle_group', group_id=group.id) }}" method="post" class="d-inline">
                        <button type="submit" class="btn btn-sm {% if group.enabled %}btn-success{% else %}btn-outline-secondary{% endif %}">
                            {% if group.enabled %}<i class="bi bi-toggle-on"></i> Active{% else %}<i class="bi bi-toggle-off"></i> Disabled{% endif %}
                        </button>
                    </form>
                </div>
            </div>
            <div class="card-body">
                <p class="small text-muted">ID: {{ group.id[:20] }}...</p>

                <h6>Assigned Bots:</h6>
                {% if group.bot_assignments %}
                    <div class="mb-3">
                        {% for assignment in group.bot_assignments %}
                        <span class="badge bg-primary me-1 mb-1">
                            {{ assignment.bot.name }}
                            <form action="{{ url_for('unassign_bot_from_group', group_id=group.id, bot_id=assignment.bot.id) }}" method="post" class="d-inline">
                                <button type="submit" class="btn-close btn-close-white ms-1" style="font-size: 0.6rem;" title="Remove"></button>
                            </form>
                        </span>
                        {% endfor %}
                    </div>
                {% else %}
                    <p class="text-muted small">No bots assigned</p>
                {% endif %}

                <h6 class="mt-3">Members:</h6>
                {% set members = group_members.get(group.id, []) %}
                {% if members %}
                    <div class="mb-3">
                        {% for member in members %}
                        <span class="badge bg-secondary me-1 mb-1">
                            <i class="bi bi-person"></i> {{ member.name }}
                        </span>
                        {% endfor %}
                    </div>
                {% else %}
                    <p class="text-muted small">No members found (members appear after messages are received)</p>
                {% endif %}

                <form action="{{ url_for('assign_bot_to_group', group_id=group.id) }}" method="post" class="mt-3">
                    <div class="input-group input-group-sm">
                        <select name="bot_id" class="form-select">
                            <option value="">Add bot...</option>
                            {% for bot in bots %}
                                {% set already_assigned = group.bot_assignments|selectattr('bot_id', 'equalto', bot.id)|list|length > 0 %}
                                {% if not already_assigned %}
                                <option value="{{ bot.id }}">{{ bot.name }}</option>
                                {% endif %}
                            {% endfor %}
                        </select>
                        <button type="submit" class="btn btn-outline-primary">
                            <i class="bi bi-plus"></i>
                        </button>
                    </div>
                </form>
            </div>
        </div>
    </div>

    <!-- Delete Confirmation Modal for {{ group.name }} -->
    <div class="modal fade" id="deleteGroupModal-{{ loop.index }}" tabindex="-1">
        <div class="modal-dialog">
            <div class="modal-content">
                <div class="modal-header">
                    <h5 class="modal-title">Delete Group</h5>
                    <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
                </div>
                <div class="modal-body">
                    <p>Are you sure you want to delete <strong>{{ group.name }}</strong>?</p>
                    <p class="text-muted small">This will also remove all bot assignments for this group.</p>
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancel</button>
                    <form action="{{ url_for('delete_group', group_id=group.id) }}" method="post" class="d-inline">
                        <button type="submit" class="btn btn-danger">
                            <i class="bi bi-trash"></i> Delete Group
                        </button>
                    </form>
                </div>
            </div>
        </div>
    </div>
    {% else %}
    <div class="col-12">
        <div class="alert alert-info">
            <i class="bi bi-info-circle"></i> No groups connected yet. Click "Add Group" to connect one.
            <br><br>
            <strong>How to get your Group ID:</strong>
            <ol class="mb-0">
                <li>Make sure your bot's phone is registered with Signal</li>
                <li>Add the bot to your Signal group</li>
                <li>The group ID will appear in the API logs, or use the Signal CLI to list groups</li>
            </ol>
        </div>
    </div>
    {% endfor %}
</div>

<!-- Add Group Modal -->
<div class="modal fade" id="addGroupModal" tabindex="-1">
    <div class="modal-dialog">
        <div class="modal-content">
            <form action="{{ url_for('add_group') }}" method="post">
                <div class="modal-header">
                    <h5 class="modal-title">Add Signal Group</h5>
                    <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
                </div>
                <div class="modal-body">
                    <div class="mb-3">
                        <label class="form-label">Group Name</label>
                        <input type="text" name="name" class="form-control" placeholder="My Cool Group Chat" required>
                        <small class="text-muted">A friendly name for this group</small>
                    </div>
                    <div class="mb-3">
                        <label class="form-label">Signal Group ID</label>
                        <input type="text" name="group_id" class="form-control" placeholder="base64-encoded-group-id" required>
                        <small class="text-muted">The internal Signal group identifier</small>
                    </div>
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancel</button>
                    <button type="submit" class="btn btn-primary">Add Group</button>
                </div>
            </form>
        </div>
    </div>
</div>
{% endblock %}
